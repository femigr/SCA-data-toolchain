pipeline {
    agent any 
    parameters {
        string(name: 'REPO_URL', defaultValue: 'https://github.com/openssl/openssl.git', description: 'Https clone link');
        string(name: 'REVISION', defaultValue: '', description: 'Specific revision to checkout (for example a commit hash), leave empty to just pull the current state of the main branch');
        string(name: 'LANGUAGE', defaultValue: 'cpp', description: 'The programming language');
        string(name: 'BUILD_COMMAND', defaultValue: '', description: 'Command that builds the repo, leave empty to attempt auto-detection')
    }
    options {
        timeout(time: 15, unit: 'MINUTES', activity: true)
    }
    stages {
        stage('Get Repository') { 
            steps {
                git url: env.REPO_URL, changelog: false
                script{
                    if(env.REVISION != ''){
                        sh 'git checkout ' + env.REVISION
                    }
                    sh 'git status'
                }
            }
        }
        stage('CodeQL'){
            stages{
                stage('Setup CodeQL'){
                    steps{
                        //sh 'wget -O codeQL.zip https://github.com/github/codeql-cli-binaries/releases/download/v2.5.7/codeql-linux64.zip'
                        //unzip zipFile: 'codeQL.zip'
                        sh '''
                            wget -q https://github.com/github/codeql-action/releases/latest/download/codeql-bundle-linux64.tar.gz
                            tar -xvzf codeql-bundle-linux64.tar.gz
                        '''
                        sh 'ls -a'
                        dir('codeql'){
                            sh "chmod +x codeql"
                        }
                        dir('codeql/tools/linux64/java/bin'){
                            sh "chmod +x java"
                        }
                        echo env.PATH
                        script{
                            env.PATH += ':' + env.WORKSPACE + '/codeql'
                        }
                        echo env.PATH
                        sh 'codeql resolve qlpacks'
                        sh 'codeql resolve languages'
                    }
                }
                stage('Build CodeQL Database'){
                    steps{
                        script{
                            command = 'codeql database create --language=' + env.LANGUAGE + ' codeQlDb'
                            if(env.BUILD_COMMAND != ''){
                                command += ' --command=' + env.BUILD_COMMAND
                            }
                            sh command
                        }
                    }
                }
                stage('Run CodeQL Queries'){
                    steps{
                        sh 'codeql database analyze --format=sarif-latest --output=codeQlScan.sarif codeQlDb cpp-lgtm-full.qls'
                    }
                }
            }
        }
    }
    post {
        always {
            deleteDir()
        }
    }
}